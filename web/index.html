<html xmlns="http://www.w3.org/1999/html">
<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.0.5/angular.min.js"></script>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
<script src="http://code.highcharts.com/highcharts.js"></script>
<script src="http://code.highcharts.com/highcharts-more.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
<script src="https://d14fo0winaifog.cloudfront.net/plotly-basic.js"></script>
<script src="app.js"></script>
<script src="yo.js"></script>
<link rel="stylesheet" href="style.css">
<style>
  body {
    padding-top: 60px;
  }
  @media (max-width: 980px) {
    body {
      padding-top: 0;
    }
  }
</style>
<head>
    <title>
        API Analysis Tool
    </title>
</head>
<script>
$(document).ready(function() {
    constructPage("alchemyapi");
    $("button").click(function() {
        var bla = $('#textBox').val();
        constructPage(bla);
    });
});

</script>
<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#"><img style="max-width:100px; margin-top: -7px;"
             src="logo.png"></a>

    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">      <form class="navbar-form navbar-left" role="search">
        <div class="form-group">
          <input type="text" class="form-control" id="textBox" placeholder="Search">
        </div>
        <button type="button" id="button" class="btn btn-default">Submit</button>
      </form>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="#">by natalie mcmullen</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

<script>
function constructPage(query) {

    var json = $.getJSON("https://api.stackexchange.com/2.2/search/excerpts?order=desc&sort=creation&title=" + query + "&key=wAaCCVnUr8E)MkHlSesT5A((&site=stackoverflow", function() {})

    var twitt = $.get("api/" + encodeURIComponent(query)).success(function(data) {});

    var allStackData;
    var allTwittData, twAvg, sOAvg, joinedTweets, joinedStacks;
    var allTweets = [];
    var allArticles = [];
    var sendIn;
    var allSentiments = [];
    var textAnalyzed = [];
    var allTweetSentiments = [];
    var flag = false;
    var visualSentimentsT = [];
    var visualSentiments = [];
    json.success(function() {
        twitt.success(function() {
            allStackData = json.responseJSON.items;
            allTwittData = twitt.responseJSON.statuses;


            for (var i = 0; i < allTwittData.length; i++) {
                (function(i) {
                    allTweets[i] = [];
                    allTweets[i].push(allTwittData[i].text);
                })(i);
            }




            for (var j = 0; j < allTweets.length; j++) {
                (function(j) {
                    handleTwitterRequests(j, allTweets[j]);
                })(j);

            }

            for (var i = 0; i < allStackData.length; i++) {
                (function(i) {
                    allArticles[i] = [];
                    allArticles[i].push(allStackData[i].body);
                })(i);
            }
            for (var j = 0; j < allArticles.length; j++) {
                (function(j) {
                    handleJsonRequests(j, allArticles[j]);
                })(j);
            }


        });

    });





    function handleJsonRequests(index, id) {


        var alchemized = $.getJSON("http://access.alchemyapi.com/calls/text/TextGetTextSentiment?text=" + id + "&apikey=85e62ad889b1b15314bb96cf6387592215231fc5&outputMode=json", function() {

        })

        alchemized.success(function() {
            if (isNaN(Number(alchemized.responseJSON.docSentiment.score))) {
                allSentiments.push({
                    id: id,
                    sentiment: 0.01
                })
            } else {
                allSentiments.push({
                    id: id,
                    sentiment: parseFloat(alchemized.responseJSON.docSentiment.score)
                });
                visualSentiments.push(parseFloat(alchemized.responseJSON.docSentiment.score));

                var newHTML2 = [];
                for (var i = 0; i < allSentiments.length; i++) {
                    (function(i) {

                        var vally = allSentiments[i].sentiment;
                        var sentColor = "green";
                        if (vally === undefined || vally === null) {
                            vally = 0.001
                        }
                        if (vally <= 0.01 && vally >= -0.01) {
                            sentColor = "grey";
                        }
                        if (vally > 0.01) {
                            sentColor = "green";
                        }
                        if (vally < -0.01) {
                            sentColor = "red";
                        }
                        newHTML2.push('<p><span>' + '<i class="fa fa-stack-overflow"></i>+<font color =' + sentColor + '>' + allSentiments[i].id + '</font></span><br></p>');
                    })(i);

                }
                $("#MyEdit2").html(newHTML2.join(""));
            }
            var dataCleaner = [];
            visualSentimentsT = unique(visualSentimentsT);

            for (var i = 0; i < visualSentimentsT.length; i++) {
                var formatted = [visualSentimentsT[i], visualSentimentsT[i]];
                dataCleaner.push(formatted);
            }

            var dataCleaner2 = [];
            visualSentiments = unique(visualSentiments);

            for (var i = 0; i < visualSentiments.length; i++) {
                var formatted = [visualSentiments[i], visualSentiments[i]];
                dataCleaner2.push(formatted);
            }

            $('#container').highcharts({
                chart: {
                    type: 'bubble',
                    zoomType: 'xy'
                },
                title: {
                    text: 'Area chart with negative values'
                },
                credits: {
                    enabled: false
                },
                series: [{
                    name: 'Stack Overflow',
                    data: dataCleaner2
                }, {
                    name: 'Twitter',
                    data: dataCleaner
                }]
            });
            twAvg = average(visualSentimentsT);
            sOAvg = average(visualSentiments);
            $(function() {
                $('#container2').highcharts({
                    chart: {
                        type: 'column'
                    },
                    title: {
                        text: 'Average Sentiment'
                    },
                    xAxis: {},
                    credits: {
                        enabled: false
                    },
                    series: [{
                        name: 'Twitter',
                        data: [twAvg]
                    }, {
                        name: 'Stack Overflow',
                        data: [sOAvg]
                    }]
                });
            });
            if (flag === false) {
                var alchemizedEntities = $.getJSON("http://access.alchemyapi.com/calls/text/TextGetCombinedData?text=" + joinedTweets + "&apikey=85e62ad889b1b15314bb96cf6387592215231fc5&outputMode=json", function() {})
                alchemizedEntities.complete(function() {
                    flag = true;
                    textAnalyzed.push('<span>' + '<i class="fa fa-check"></i>+<font color =' + "green" + '>' + alchemizedEntities.responseJSON.keywords[0].text + '</font></span><br>');
                    textAnalyzed.push('<span>' + '<i class="fa fa-check"></i>+<font color =' + "green" + '>' + alchemizedEntities.responseJSON.keywords[1].text + '</font></span><br>');
                    textAnalyzed.push('<span>' + '<i class="fa fa-check"></i>+<font color =' + "green" + '>' + alchemizedEntities.responseJSON.keywords[2].text + '</font></span><br>');

                    $("#ents1").html(textAnalyzed.join(""));
                })
            }
        });

    };


    function handleTwitterRequests(index, id) {
        var alchemized2 = $.getJSON("http://access.alchemyapi.com/calls/text/TextGetTextSentiment?text=" + id + "&apikey=85e62ad889b1b15314bb96cf6387592215231fc5&outputMode=json", function() {

        })
        alchemized2.success(function() {
            if (isNaN(parseFloat(alchemized2.responseJSON.docSentiment.score))) {
                allTweetSentiments.push({
                    id: id,
                    sentiment: 0.0001
                })
            } else {
                allTweetSentiments.push({
                    id: id,
                    sentiment: parseFloat(alchemized2.responseJSON.docSentiment.score)
                });
                visualSentimentsT.push(parseFloat(alchemized2.responseJSON.docSentiment.score));

                var newHTML = [];
                for (var i = 0; i < allTweetSentiments.length; i++) {
                    (function(i) {
                        var vally2 = allTweetSentiments[i].sentiment;
                        var sentColor2 = "green";
                        if (vally2 === undefined || vally2 === null) {
                            vally2 = 0.001
                        }
                        if (vally2 <= 0.01 && vally2 >= -0.01) {
                            sentColor2 = "grey";
                        }
                        if (vally2 > 0.01) {
                            sentColor2 = "green";
                        }
                        if (vally2 < -0.01) {
                            sentColor2 = "red";
                        }
                        newHTML.push('<p><span>' + '<i class="fa fa-twitter"></i>+<font color =' + sentColor2 + '>' + allTweetSentiments[i].id + '</font></span><br></div></p>');
                        joinedTweets = allTweetSentiments[i].id.join();
                    })(i);
                }
                $("#MyEdit").html(newHTML.join(""));

            }
        })

    };

};


function average(array) {
    var total = 0;
    for (var i = 0; i < array.length; i++) {
        total += array[i];
    }
    return avg = total / array.length;
}

//When we have multiple tweets come in at a time. 
function unique(origArr) {
    var newArr = [],
        origLen = origArr.length,
        found, x, y;

    for (x = 0; x < origLen; x++) {
        found = undefined;
        for (y = 0; y < newArr.length; y++) {
            if (origArr[x] === newArr[y]) {
                found = true;
                break;
            }
        }
        if (!found) {
            newArr.push(origArr[x]);
        }
    }
    return newArr;
}
</script>
<body>
<div class="row">
    <div id="container2" class="col-md-4"></div>
    <div id="container" class="col-md-4" style="min-width: 310px; max-width: 800px; height: 400px; margin: 0 auto"></div>
</div>
<div class="row">
    <div id="ents1" class="col-md-4"></div>
    <div id="MyEdit" class="col-md-4"></div>
    <div id="MyEdit2" class="col-md-4"></div>
</div>

</body>

</html>